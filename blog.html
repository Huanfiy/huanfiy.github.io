<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客 - Haunfly</title>
    <link rel="icon" type="image/png" href="picture/icon.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Marked.js 用于解析 Markdown (主CDN + 备用CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script>
        // 如果主 CDN 加载失败，尝试备用 CDN
        if (typeof marked === 'undefined') {
            document.write('<script src="https://unpkg.com/marked@4.0.12/marked.min.js"><\/script>');
        }
    </script>
    <script>
        // 二次检查，如果仍然失败，尝试 cdnjs
        if (typeof marked === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.12/marked.min.js"><\/script>');
        }
    </script>
</head>
<body>

    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="picture/icon.png" alt="Logo">
                <span>Haunfly</span>
            </a>
            <div class="menu-toggle"><i class="fas fa-bars"></i></div>
            <nav class="nav-links">
                <a href="index.html">主页</a>
                <a href="blog.html" class="active">博客</a>
                <a href="tool.html">工具</a>
                <a href="about.html">关于</a>
            </nav>
        </div>
    </header>

    <!-- 列表展示区域 -->
    <main id="blog-list-view" class="container" style="padding-top: 2rem;">
        <h2 class="section-title" data-aos="fade-up">最新文章</h2>
        
        <!-- 文章分类标签 (示例) -->
        <div class="flex justify-center gap-4 mb-8" data-aos="fade-up" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 3rem;">
            <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.9rem;">全部</button>
            <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.9rem;">技术</button>
            <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.9rem;">生活</button>
        </div>

        <div class="grid-3" id="blog-cards-grid">
            <!-- 文章卡片由 JS 从 posts.json 动态渲染 -->
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                <p style="color: var(--light-text); margin-top: 1rem;">加载文章列表...</p>
            </div>
        </div>
    </main>

    <!-- 文章详情阅读区域 (默认隐藏) -->
    <div id="blog-detail-view" class="container" style="display: none; padding-top: 2rem;">
        <button onclick="closeMarkdown()" class="btn btn-outline" style="margin-bottom: 2rem;">
            <i class="fas fa-arrow-left"></i> 返回列表
        </button>
        <div id="markdown-content" class="markdown-body">
            <!-- Markdown 内容将渲染在这里 -->
        </div>
    </div>

    <footer>
        <div class="container">
            <p style="color: var(--light-text); font-size: 0.9rem;">&copy; 2026 Haunfly. 保留所有权利。</p>
        </div>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="js/script.js"></script>
    <script>
        AOS.init({ duration: 800, once: true });

        // === 默认配图：基于 tag 生成 SVG 渐变图 ===
        const TAG_GRADIENTS = {
            'Git':   ['#667eea', '#764ba2'],
            'Linux': ['#11998e', '#38ef7d'],
            '随笔':  ['#ee9ca7', '#ffdde1'],
            '前端':  ['#f7971e', '#ffd200'],
            '后端':  ['#4facfe', '#00f2fe'],
        };
        const DEFAULT_GRADIENT = ['#6ab04c', '#7ed6df'];

        function getCoverUrl(post) {
            if (post.cover) return post.cover;
            const [c1, c2] = TAG_GRADIENTS[post.tag] || DEFAULT_GRADIENT;
            const label = post.tag || 'Blog';
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="250">
                <defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="${c1}"/><stop offset="100%" stop-color="${c2}"/>
                </linearGradient></defs>
                <rect width="400" height="250" fill="url(#g)"/>
                <text x="200" y="135" text-anchor="middle" fill="white" font-size="28"
                      font-family="sans-serif" opacity="0.6">${label}</text>
            </svg>`;
            return 'data:image/svg+xml,' + encodeURIComponent(svg);
        }

        // === 动态渲染文章卡片 ===
        function renderBlogCards(posts) {
            const grid = document.getElementById('blog-cards-grid');
            if (!posts.length) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--light-text);">暂无文章</div>';
                return;
            }
            grid.innerHTML = posts.map((post, i) => `
                <article class="card blog-card" data-aos="fade-up" data-aos-delay="${i * 100}"
                         onclick="loadMarkdown('${post.file}')" style="cursor:pointer;">
                    <img src="${getCoverUrl(post)}" alt="${post.tag || '文章'}" class="${post.coverFit === 'contain' ? 'contain' : ''}">
                    <div class="blog-meta">
                        <span><i class="far fa-calendar"></i> ${post.date}</span>
                        ${post.tag ? `<span class="blog-tag">${post.tag}</span>` : ''}
                    </div>
                    <h3 class="blog-title">${post.title}</h3>
                    <p style="color:var(--light-text);font-size:0.95rem;margin-bottom:1rem;">${post.summary || ''}</p>
                    <div style="margin-top:auto;color:var(--primary-color);font-weight:600;">阅读全文</div>
                </article>
            `).join('');
            AOS.refresh();
        }

        // 页面加载时拉取文章清单
        fetch('posts/posts.json')
            .then(r => { if (!r.ok) throw new Error('加载失败'); return r.json(); })
            .then(posts => renderBlogCards(posts))
            .catch(() => {
                document.getElementById('blog-cards-grid').innerHTML =
                    '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:red;"><i class="fas fa-exclamation-triangle"></i> 文章列表加载失败，请刷新重试</div>';
            });

        // === 剥离 Front Matter ===
        function stripFrontMatter(text) {
            if (!text.startsWith('---')) return text;
            const end = text.indexOf('\n---', 3);
            if (end === -1) return text;
            return text.substring(end + 4).trimStart();
        }

        // === 加载并渲染 Markdown 文章 ===
        function loadMarkdown(file) {
            const contentDiv = document.getElementById('markdown-content');
            contentDiv.innerHTML = '<div style="text-align:center;padding:2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>加载中...</p></div>';

            document.getElementById('blog-list-view').style.display = 'none';
            document.getElementById('blog-detail-view').style.display = 'block';
            window.scrollTo(0, 0);

            if (typeof marked === 'undefined') {
                contentDiv.innerHTML = `<div style="text-align:center;color:red;padding:2rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:1rem;"></i>
                    <p>Markdown 解析库加载失败</p>
                    <p style="font-size:0.9rem;color:var(--light-text);">请检查网络连接后刷新页面</p>
                </div>`;
                return;
            }

            fetch(file)
                .then(response => {
                    if (!response.ok) throw new Error('文章加载失败');
                    return response.text();
                })
                .then(text => {
                    contentDiv.innerHTML = marked.parse(stripFrontMatter(text));
                })
                .catch(error => {
                    contentDiv.innerHTML = `<div style="text-align:center;color:red;">
                        <i class="fas fa-exclamation-triangle"></i> 文章加载出错: ${error.message}
                    </div>`;
                });
        }

        function closeMarkdown() {
            document.getElementById('blog-detail-view').style.display = 'none';
            document.getElementById('blog-list-view').style.display = 'block';
            setTimeout(() => AOS.refresh(), 100);
        }
    </script>
</body>
</html>
